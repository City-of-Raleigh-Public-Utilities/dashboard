
<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../../assets/ico/favicon.ico">

    <title>Public Utilities GIS Edits Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link href="../dashboard/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../dashboard/dist/css/stylesheet.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    
    <link rel="icon" type="image/ico" href="../dashboard/dist/img/favicon.ico" />

    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

   <div class="navbar navbar-inverse navbar-fixed-top" style="background-color:#5c8fea;" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" style="color:white;" href="../dashboard/index.html">Public Utilites Dashboard</a>
        </div>
        <div class="navbar-collapse collapse" >
          <ul class="nav navbar-nav" style="background-color:#5c8fea;">
            <li class="dropdown">
          <a href="../dashboard/water.html" class="dropdown-toggle" style='color:white;' data-toggle="dropdown">Water <b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a href="../dashboard/water.html">Water Stats</a></li>
            <li class="divider"></li>
            <li><a href="../dashboard/water.html#mainsPieChartContainer">Water Mains</a></li>
            <li><a href="../dashboard/water.html#lateralPieChartContainer">Water Laterals</a></li>
            <li><a href="../dashboard/water.html#valvesPieChartContainer">Water Valves</a></li>
            <li><a href="../dashboard/water.html#fittingChart">Water Fittings</a></li>
          </ul>
        </li>
         <li class="dropdown">
          <a href="../dashboard/sewer.html" class="dropdown-toggle" style='color:white;' data-toggle="dropdown">Sewer<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a href="../dashboard/sewer.html">Sewer Stats</a></li>
            <li class="divider"></li>
            <li><a href="../dashboard/sewer.html#gravmainsPieChartContainer">Gravity Mains</a></li>
            <li><a href="../dashboard/sewer.html#forcemainPieChartContainer">Force Mains</a></li>
            <li><a href="../dashboard/sewer.html#lateralPieChartContainer">Laterals</a></li>
            <li><a href="../dashboard/sewer.html#manholesPieChartContainer">Manholes</a></li>
            <li><a href="../dashboard/sewer.html#cleanoutPieChartContainer">Cleanouts</a></li>
            <li><a href="../dashboard/sewer.html#fittingChart">Fittings</a></li>
          </ul>
        </li>
            
          </ul>
          
        </div><!--/.navbar-collapse -->
      </div>
    </div>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    
      <div class="container">
        <br><br>
      </div>
    

    <div class="container" >
      <!-- Example row of columns -->
      
      <div class="row" >
          <div class="col-md-12" >
            <h1 class="text-success">Water and Sewer System Statistics  <small id='date'></small></h1>
            
          </div>
      </div>
      <div class="row">
        <div class="col-md-4 bg-info">
          <h2 class="text-primary">Pressure Mains</h2>
            <p id='pressuremains'></p>
          <h2 class="text-primary">Water System Valves</h2>
            <p id='systemvalves'></p>
          <h2 class="text-primary">Water Service Connections</h2>
            <p id='waterserviceconnection'></p>
          <h2 class="text-primary">Hydrants</h2>
            <ul id='hydrants' class="list-group"></ul>
          <h2 class="text-primary">Water Network Structures</h2>
            <ul id='WNS' class="list-group"></ul>
        </div>


        <div class="col-md-4 bg-success">
          <h2 class="text-success">Gravity Mains</h2>
            <p id='gravityMains'></p>
          <h2 class="text-success">Manholes</h2>
            <p id='manholes'></p>
          <h2 class="text-success">Cleanouts</h2>
            <p id='cleanouts'></p>
          <h2 class="text-success">Sewer Network Structures</h2>
            <ul id='SNS' class="list-group"></ul>
        </div>
        
        <div class="col-md-4" style="background-color:#D4A9EC">
          <h2 style="color:#491256">Reuse Pressure Mains</h2>
            <p id='reusepressuremains'></p>
          <h2 style="color:#491256">Reuse System Valves</h2>
            <p id='reusesystemvalves'></p>
          <h2 style="color:#491256">Reuse Service Connections</h2>
            <p id='reuseserviceconnections'></p>
          <h2 style="color:#491256">Reuse Network Structures</h2>
            <ul id='RNS' class="list-group"></ul>
        </div>
  
      <br><br>

     
    </div> <!-- /container -->
     <footer>
        <p>&copy; City of Raleigh- Public Utilities 2014</p>
      </footer>
    </div>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!--<script src="../dashboard/dist/js/jquery-2.0.3.min.js"></script>-->
    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    
    
    <script src="../dashboard/dist/js/Chart.js"></script>
    <script src="../dashboard/dist/js/bootstrap.min.js"></script>
    <!--<script src="../dashboard/dist/data/sewer.json"></script>-->
    <script src="http://js.arcgis.com/3.8/"></script>
    <script type="text/javascript">


//Radar
//***************************************************************************************
//Range Selector
//*****************************************************************
//Gets the current date to set as the end date for the range selector
function getCurrentDate(){
  var today = new Date();
  var dd = today.getDate();
  var mm = today.getMonth()+1; //January is 0!
  var yyyy = today.getFullYear();
  return mm + '/' + dd + '/'+  yyyy;

}


$("#date").append(getCurrentDate());




//*****************************************************************
  
  var sindex = [0, 3, 4, 14]; //sewer
  var windex = [2,3,11,5, 7]; //water
  var rindex = [2,4,7,8] //array where query dates will be stored

//*********************************************************************************
function createUrl(index, type){
  var url = "http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/"+ type + "/MapServer/" + index;
  return url;
}
//***********************************************************************************************
function createOutStat(index, type){
  if (type == 'WaterDistribution' ){
  if (index == 3 || index == 5 ){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "count";
      statisticDefinition.onStatisticField = "FACILITYID";
      statisticDefinition.outStatisticFieldName = "COUNT";
    var outStats = [statisticDefinition];
    //var outStats = "[{statisticType: count, onStatisticField: EDITEDBY, outStatisticFieldName: EDITED }, {statisticType: count, onStatisticField: CREATEDBY, outStatisticFieldName: CREATED}]";
    return outStats;
  }
  else if (index == 11 ){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "sum";
      statisticDefinition.onStatisticField = "SHAPE.LEN";
      statisticDefinition.outStatisticFieldName = "SHAPELEN";
    
    var outStats = [statisticDefinition];
    //var outStats = "[{statisticType:  sum, onStatisticField: SHAPE.LEN, outStatisticFieldName: SHAPELEN }, {statisticType: count , onStatisticField: EDITEDBY, outStatisticFieldName: EDITED }, {statisticType: count , onStatisticField: CREATEDBY, outStatisticFieldName: CREATED }]"

return outStats;
  }
  else if (index == 2 ){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "count";
      statisticDefinition.onStatisticField = "STRUCTTYPE";
      statisticDefinition.outStatisticFieldName = "TYPE";
    
    var outStats = [statisticDefinition];
   
return outStats;
  }
  else if (index == 7 ){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "count";
      statisticDefinition.onStatisticField = "OWNEDBY";
      statisticDefinition.outStatisticFieldName = "TYPE";
    
    var outStats = [statisticDefinition];
   
return outStats;
  }
}
 if (type == 'SewerCollection' ){
  if (index == 0 || index == 4){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "count";
      statisticDefinition.onStatisticField = "FACILITYID";
      statisticDefinition.outStatisticFieldName = "COUNT";
    var outStats = [statisticDefinition];
    //var outStats = "[{statisticType: count, onStatisticField: EDITEDBY, outStatisticFieldName: EDITED }, {statisticType: count, onStatisticField: CREATEDBY, outStatisticFieldName: CREATED}]";
    return outStats;
  }
  else if (index == 14){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "sum";
      statisticDefinition.onStatisticField = "SHAPE.LEN";
      statisticDefinition.outStatisticFieldName = "SHAPELEN";
    
    var outStats = [statisticDefinition];
    //var outStats = "[{statisticType:  sum, onStatisticField: SHAPE.LEN, outStatisticFieldName: SHAPELEN }, {statisticType: count , onStatisticField: EDITEDBY, outStatisticFieldName: EDITED }, {statisticType: count , onStatisticField: CREATEDBY, outStatisticFieldName: CREATED }]"

return outStats;
  }
  else if (index == 3){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "count";
      statisticDefinition.onStatisticField = "STRUCTTYPE";
      statisticDefinition.outStatisticFieldName = "COUNT";
    
    var outStats = [statisticDefinition];
   
return outStats;
  }
  
}
if (type == 'ReclaimedDistribution' ){
  if (index == 2 || index == 7){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "count";
      statisticDefinition.onStatisticField = "FACILITYID";
      statisticDefinition.outStatisticFieldName = "COUNT";
    var outStats = [statisticDefinition];
    //var outStats = "[{statisticType: count, onStatisticField: EDITEDBY, outStatisticFieldName: EDITED }, {statisticType: count, onStatisticField: CREATEDBY, outStatisticFieldName: CREATED}]";
    return outStats;
  }
  else if (index == 8){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "sum";
      statisticDefinition.onStatisticField = "SHAPE.LEN";
      statisticDefinition.outStatisticFieldName = "SHAPELEN";
    
    var outStats = [statisticDefinition];
    //var outStats = "[{statisticType:  sum, onStatisticField: SHAPE.LEN, outStatisticFieldName: SHAPELEN }, {statisticType: count , onStatisticField: EDITEDBY, outStatisticFieldName: EDITED }, {statisticType: count , onStatisticField: CREATEDBY, outStatisticFieldName: CREATED }]"

return outStats;
  }
  else if (index == 4){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "count";
      statisticDefinition.onStatisticField = "STRUCTTYPE";
      statisticDefinition.outStatisticFieldName = "COUNT";
    
    var outStats = [statisticDefinition];
   
return outStats;
  }


}

}
//*********************************************************************************
function groupField(index, type){
  if (index == 2 && type == 'WaterDistribution' ){
    return  ["STRUCTTYPE"];
  }
  else if (index == 3 && type == 'SewerCollection' ){
    return  ["STRUCTTYPE"];
  }
  else if (index == 4 && type == 'ReclaimedDistribution'){
    return ["STRUCTTYPE"];
  }
  else if (index == 7 && type == 'WaterDistribution'){
    return ["OWNEDBY"];
  }
  else{
    return
  }
  
}
  

//******************************************************************************
function clearArray(array){
  while (array.length > 0) {
    array.pop();
  }
  
}


//***************************************************************************



function calling(index, type){

require([
   "dojo/on", "esri/tasks/query", "esri/tasks/QueryTask",  "dojo/dom", "dojo/domReady!", "esri/tasks/StatisticDefinition"
], function(on, Query, QueryTask, dom, StatisticDefinition) {

  var query = new Query();
  var queryTask = new QueryTask(createUrl(index, type), {handleAs: "pjson", callbackParamName: "callback"});
  
  query.returnGeometry = false;
  query.f = 'pjson';
  query.outStatistics = createOutStat(index, type);
  
  query.groupByFieldsForStatistics = groupField(index, type)
  
  //on(dom.byId("execute"), "click", execute);

  function execute(){
    queryTask.execute(query, showResults);
  }


  ///////////////////////////////////////////////////////////////////////////////////////
  if (type == 'WaterDistribution'){


  
    function showResults(response) {

      for (each in response.features){
        
//Water Stats
          if (index == 11 ){
          miles = new Number(response.features[each].attributes["SUM(SHAPE.LEN) AS SHAPELEN"] /5280);
          rounded = parseFloat(miles.toPrecision(5));
          document.getElementById("pressuremains").innerHTML="Miles of Pressure Mains: " + rounded;
        }
        
        if (index == 5 ){
         var total = response.features[each].attributes.COUNT;
          document.getElementById("systemvalves").innerHTML="Number of System Valves: " + total;
        }  
        if (index == 3){
         var total = response.features[each].attributes.COUNT;
          document.getElementById("waterserviceconnection").innerHTML="Number of Service Connections: " + total;
        }    
        if (index == 7 ){
         var type = response.features[each].attributes.OWNEDBY;
         var total = response.features[each].attributes.TYPE;
         //console.log(response.features)
        if (type == 2){
          type = 'COR';
        } 
        else if (type == 1){
          type = 'Private';
        }
        else if (type == 0){
          type = 'Other';
        }
        var li = "<li class='list-group-item' style='background-color:#EFF3FF'>";
        $("#hydrants").append(li.concat('<span class="badge">'+ total + '</span>' + type ));
        } 
        if (index == 2 ){
         var total = response.features[each].attributes.TYPE;
         var type = response.features[each].attributes.STRUCTTYPE;
        var li = "<li class='list-group-item' style='background-color:#EFF3FF'>";
        $("#WNS").append(li.concat('<span class="badge">'+ total + '</span>' + type));
        } 
       
    }
    }
    }
    else if (type == 'SewerCollection'){    
      function showResults(response) {
        
      for (each in response.features){
        
        
//Sewer Stats
        if (index == 14  ){
          miles = new Number(response.features[each].attributes["SUM(SHAPE.LEN) AS SHAPELEN"] /5280);
          rounded = parseFloat(miles.toPrecision(5));
          document.getElementById("gravityMains").innerHTML="Miles of Gravity Mains: " + rounded; 
        }  
        if (index == 4 ){
          var total = response.features[each].attributes.COUNT;
          document.getElementById("cleanouts").innerHTML="Number of Cleanouts: " + total;
        }  
        if (index == 0 ){
         var total = response.features[each].attributes.COUNT;
          document.getElementById("manholes").innerHTML="Number of Manholes: " + total;
        }    
        if (index == 3 ){
         var total = response.features[each].attributes.COUNT;
         var type = response.features[each].attributes.STRUCTTYPE;
          var li = "<li class='list-group-item' style='background-color:#F0F8EE'>";
        $("#SNS").append(li.concat('<span class="badge">'+ total + '</span>' + type));
        }  
        
      } //end for loop
  
    }//end Show Results
    } //end if sewer

     else if (type == 'ReclaimedDistribution'){    
      function showResults(response) {
        
      for (each in response.features){
        
        
//Sewer Stats
        if (index == 8 ){
          miles = new Number(response.features[each].attributes["SUM(SHAPE.LEN) AS SHAPELEN"] /5280);
          rounded = parseFloat(miles.toPrecision(5));
          document.getElementById("reusepressuremains").innerHTML="Miles of Pressure Mains: " + rounded; 
        }  
        if (index == 2 ){
          var total = response.features[each].attributes.COUNT;
          document.getElementById("reusesystemvalves").innerHTML="Number of System Valves: " + total;
        }  
        if (index == 7 ){
         var total = response.features[each].attributes.COUNT;
          document.getElementById("reuseserviceconnections").innerHTML="Number of Service Connections: " + total;
        }    
        if (index == 4 ){
         var total = response.features[each].attributes.COUNT;
         var type = response.features[each].attributes.STRUCTTYPE;
         var li = "<li class='list-group-item' style='background-color:#F5EFFF'>";
        $("#RNS").append(li.concat('<span class="badge">'+ total + '</span>' + type));
        }  
        
      } //end for loop
  
    }//end Show Results
    } //end if sewer
      
      
    //end of results function
  execute();
  });
  
      
} //end of calling()
for (i in sindex){
    calling(sindex[i],'SewerCollection');
    }//end of for loop
for (i in windex){
  calling(windex[i], 'WaterDistribution');
}
for (i in rindex){
  calling(rindex[i], 'ReclaimedDistribution');
}




    </script>
  </body>
</html>
