
<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="../../assets/ico/favicon.ico">

    <title>Public Utilities GIS Edits Dashboard</title>

    <!-- Bootstrap core CSS -->
    <link href="../dashboard/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../dashboard/dist/css/stylesheet.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    
    <link rel="icon" type="image/ico" href="../dashboard/dist/img/favicon.ico" />

    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top" style="background-color:#5c8fea;" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" style="color:white;" href="../dashboard/index.html">Public Utilites Dashboard</a>
        </div>
        <div class="navbar-collapse collapse" >
          <ul class="nav navbar-nav" style="background-color:#5c8fea;">
            <li class="dropdown">
          <a href="../dashboard/water.html" class="dropdown-toggle" style='color:white;' data-toggle="dropdown">Water <b class="caret"></b></a>
          
          <ul class="dropdown-menu">
            <li><a href="../dashboard/water.html">Water Stats</a></li>
            <li class="divider"></li>
            <li><a href="../dashboard/water.html#mainsPieChartContainer">Water Mains</a></li>
            <li><a href="../dashboard/water.html#lateralPieChartContainer">Water Laterals</a></li>
            <li><a href="../dashboard/water.html#valvesPieChartContainer">Water Valves</a></li>
            <li><a href="../dashboard/water.html#fittingChart">Water Fittings</a></li>
          </ul>
        </li>
         <li class="dropdown">
          <a href="../dashboard/sewer.html" class="dropdown-toggle" style='color:white;' data-toggle="dropdown">Sewer<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a href="../dashboard/sewer.html">Sewer Stats</a></li>
            <li class="divider"></li>
            <li><a href="../dashboard/sewer.html#gravmainsPieChartContainer">Gravity Mains</a></li>
            <li><a href="../dashboard/sewer.html#forcemainPieChartContainer">Force Mains</a></li>
            <li><a href="../dashboard/sewer.html#lateralPieChartContainer">Laterals</a></li>
            <li><a href="../dashboard/sewer.html#manholesPieChartContainer">Manholes</a></li>
            <li><a href="../dashboard/sewer.html#cleanoutPieChartContainer">Cleanouts</a></li>
            <li><a href="../dashboard/sewer.html#fittingChart">Fittings</a></li>
          </ul>
        </li>
            
          </ul>
          
        </div><!--/.navbar-collapse -->
      </div>
    </div>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    
      <div class="container">
        <br><br>
      </div>
    

    <div class="container">
      <!-- Example row of columns -->
      
      <div class="row">
          <div class="col-md-12">
            <h1 class="text-success">Water Network Statistics</h1>
            <body>
              <div id="rangeSelectorContainer" style="height:100px;max-width:800px;margin: 0px auto"></div>
              
            </body>
          </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h2 class="text-success">Water Mains</h2>
          <p id='mains'></p>
           <form>
          <label><input id='wmmiles' name="sewer" type="radio" value="1" onclick="check(this.value, '#mainsPieChartContainer', mainsOptions, 'SUM(SHAPE.LEN) AS SHAPELEN', 'COUNT(EDITEDBY) AS EDITED','COUNT(CREATEDBY) AS CREATED', 'mains', 'Total Miles: ', mainTotal.miles  )" checked> Miles (Edited)</label>
          <label><input id='wmcount' name="sewer" type="radio" value="2" onclick="check(this.value, '#mainsPieChartContainer', mainsOptions, 'SUM(SHAPE.LEN) AS SHAPELEN', 'COUNT(EDITEDBY) AS EDITED','COUNT(CREATEDBY) AS CREATED', 'mains', 'Total Edits: ', mainTotal.edited  )"> Edited</label>
          <label><input id='wmcount' name="sewer" type="radio" value="3" onclick="check(this.value, '#mainsPieChartContainer', mainsOptions, 'SUM(SHAPE.LEN) AS SHAPELEN', 'COUNT(EDITEDBY) AS EDITED','COUNT(CREATEDBY) AS CREATED', 'mains', 'Total Creates: ', mainTotal.created  )"> Created</label>
        </form>
          <div id="mainsPieChartContainer" style="max-width:800px;height:400px;"></div>
        </div>
        <div class="col-md-6">
          <h2 class="text-success">Water Laterals</h2>
          <p id='laterals'></p>
          <form>
          <label><input id='wlmiles' name="sewer" type="radio" value="1" onclick="check(this.value, '#lateralPieChartContainer', lateralOptions, 'SUM(SHAPE.LEN) AS SHAPELEN', 'COUNT(EDITEDBY) AS EDITED','COUNT(CREATEDBY) AS CREATED', 'laterals', 'Total Miles: ', lateralTotal.miles  )" checked> Miles (Edited)</label>
          <label><input id='wmcount' name="sewer" type="radio" value="2" onclick="check(this.value, '#lateralPieChartContainer', lateralOptions, 'SUM(SHAPE.LEN) AS SHAPELEN', 'COUNT(EDITEDBY) AS EDITED','COUNT(CREATEDBY) AS CREATED', 'laterals', 'Total Edits: ', lateralTotal.edited  )"> Edited</label>
          <label><input id='wmcount' name="sewer" type="radio" value="3" onclick="check(this.value, '#lateralPieChartContainer', lateralOptions, 'SUM(SHAPE.LEN) AS SHAPELEN', 'COUNT(EDITEDBY) AS EDITED','COUNT(CREATEDBY) AS CREATED', 'laterals', 'Total Creates: ', lateralTotal.created  )"> Created</label>
        </form>
          <div id="lateralPieChartContainer" style="max-width:800px;height:400px;"></div>
      </div>
      <div class="row">
        <div class="col-md-6">
          <h2 class="text-success">Water Valves</h2>
          <p id='valves'></p>
          <form>
          <label><input id='wvmiles' name="sewer" type="radio" value="1" onclick="check(this.value, '#valvesPieChartContainer', valveOptions, 'EDITED', 'CREATED', 'JUNK', 'valves', 'Total Edits: ', valveTotal.edited  )"  checked> Edited</label>
          <label><input id='wvcount' name="sewer" type="radio" value="2" onclick="check(this.value, '#valvesPieChartContainer', valveOptions, 'EDITED', 'CREATED', 'JUNK', 'valves', 'Total Creates: ', valveTotal.created  )"> Created</label>
        </form>
          <div id="valvesPieChartContainer" style="max-width:800px;height:400px;"></div>
          
          <br>
   
    </div>
        
        <div class="col-md-6">
          <h2 class="text-success">Water Fittings</h2>
          <p id='fittings'></p>
          <br>
          <div id="fittingChart" style="max-width:800px;height:400px;"></div>
          
          <br>
       </div>
      </div>
      

      <hr>

      <footer>
        <p>&copy; City of Raleigh- Public Utilities 2014</p>
      </footer>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!--<script src="../dashboard/dist/js/jquery-2.0.3.min.js"></script>-->
    <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script src="../dashboard/dist/js/globalize.min.js"></script>
    <script src="../dashboard/dist/js/dx.chartjs.js"></script>
    <script src="../dashboard/dist/js/Chart.js"></script>
    <script src="../dashboard/dist/js/bootstrap.min.js"></script>
    <!--<script src="../dashboard/dist/data/sewer.json"></script>-->
    <script src="http://js.arcgis.com/3.8/"></script>
    <script type="text/javascript">


//Radar
//***************************************************************************************
//Range Selector
//*****************************************************************
//Gets the current date to set as the end date for the range selector
function getCurrentDate(type){
  var today = new Date();
  var dd = today.getDate();
  var mm = today.getMonth()+1; //January is 0!
  var yyyy = today.getFullYear();

  
if (type == 'slide'){
today = yyyy+','+mm+','+dd + ',' + '00,00,00';

return Date(today);
}
else if (type == 'sqlEnd'){
  if(dd<10) {
    dd='0'+dd
  } 

  if(mm<10) {
    mm='0'+mm
  } 
  today = yyyy+'-'+mm+'-'+dd + ' ' + '00:00:00';
  return today;
}
else if (type == "sqlBegin"){
  if(dd<10) {
    dd='0'+dd
  } 

  if(mm<10) {
    mm='0'+mm
  } 
    if (mm == 1){
      today = (yyyy - 1) +'-'+ '12' +'-'+dd + ' ' + '00:00:00';
      return today;
    }
    else{
      today = yyyy+'-'+(mm - 1)+'-'+dd + ' ' + '00:00:00';
      return today;
    }
  }
else if (type == "slideBegin"){
    if (mm == 1){
      //today = (yyyy - 1) +','+ '12' +','+ 1 + ',' + '00,00,00';
       today.setDate(1);
      today.setMonth(12);
      today.setFullYear(yyyy - 1)
      return today;
    }
    else{
      //today = yyyy+','+(mm - 1)+','+ 1 + ',' + '00,00,00';
      today.setDate(1);
      today.setMonth(mm - 1);
      today.setFullYear(yyyy)
      return today;
    }
  }
  



}



//*****************************************************************
  
  var index = [1,11,10,5]; //server indexes
  var whereDates = [] //array where query dates will be stored

//*********************************************************************************
function createUrl(index){
  var url = "http://gis.raleighnc.gov/arcgis/rest/services/PublicUtility/WaterDistribution/MapServer/" + index;
  return url;
}
//***********************************************************************************************
function createOutStat(index){
  if (index == 1 || index == 5 ){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "count";
      statisticDefinition.onStatisticField = "EDITEDBY";
      statisticDefinition.outStatisticFieldName = "EDITED";
    var createdStat =  new esri.tasks.StatisticDefinition();
      createdStat.statisticType = "count";
      createdStat.onStatisticField = "CREATEDBY";
      createdStat.outStatisticFieldName = "Created"; 
    var outStats = [statisticDefinition, createdStat];
    //var outStats = "[{statisticType: count, onStatisticField: EDITEDBY, outStatisticFieldName: EDITED }, {statisticType: count, onStatisticField: CREATEDBY, outStatisticFieldName: CREATED}]";
    return outStats;
  }
  else if (index == 10 || index == 11){
    var statisticDefinition = new esri.tasks.StatisticDefinition();
      statisticDefinition.statisticType = "sum";
      statisticDefinition.onStatisticField = "SHAPE.LEN";
      statisticDefinition.outStatisticFieldName = "SHAPELEN";
    var createdStat =  new esri.tasks.StatisticDefinition();
      createdStat.statisticType = "count";
      createdStat.onStatisticField = "EDITEDBY";
      createdStat.outStatisticFieldName = "EDITED"; 
    var editedStat =  new esri.tasks.StatisticDefinition();
      editedStat.statisticType = "count";
      editedStat.onStatisticField = "CREATEDBY";
      editedStat.outStatisticFieldName = "CREATED";
    var outStats = [statisticDefinition, createdStat, editedStat];

return outStats;
  }
  
}
//*********************************************************************************
function where(dates){
  var editors = "EDITEDBY = 'WHITEC' or EDITEDBY = 'kellerj' or EDITEDBY = 'rickerl' or EDITEDBY = 'stearnsc' or EDITEDBY = 'mazanekm' ";
  
  if (dates.length == 0){
    var dateRange = "EDITEDON >= TO_DATE('" + getCurrentDate('sqlBegin' ) + "', 'YYYY-MM-DD HH24:MI:SS') and EDITEDON <= TO_DATE('" + getCurrentDate('sqlEnd') + "', 'YYYY-MM-DD HH24:MI:SS')" ;
    return dateRange;
  }
  else{
  var fromDate = dates[(dates.length - 2)]
  var toDate = dates[(dates.length - 1)]
  var dateRange = "EDITEDON >= TO_DATE('" + fromDate + "', 'YYYY-MM-DD HH24:MI:SS') and EDITEDON <= TO_DATE('" + toDate + "', 'YYYY-MM-DD HH24:MI:SS')" ;//and CREATEDON >= TO_DATE('" + fromDate + "', 'YYYY-MM-DD HH24:MI:SS') and CREATEDON <= TO_DATE('" + toDate + "', 'YYYY-MM-DD HH24:MI:SS')"
  var sql =  dateRange;
  
  return sql;
}

  }
  

//******************************************************************************
function clearArray(array){
  while (array.length > 0) {
    array.pop();
  }
  
}


//***************************************************************************



function calling(index){
require([
   "dojo/on", "esri/tasks/query", "esri/tasks/QueryTask",  "dojo/dom", "dojo/domReady!", "esri/tasks/StatisticDefinition"
], function(on, Query, QueryTask, dom, StatisticDefinition) {

  var query = new Query();
  var queryTask = new QueryTask(createUrl(index), {handleAs: "pjson", callbackParamName: "callback"});
  
  query.outFields = ["EDITEDBY"];
  query.returnGeometry = false;
  query.f = 'pjson';
  query.groupByFieldsForStatistics = ["EDITEDBY"],
  query.outStatistics = createOutStat(index);

  //on(dom.byId("execute"), "click", execute);

  function execute(){
    query.where = where(whereDates);
    queryTask.execute(query, showResults);
  }


  // var layersRequest = esriRequest({
  //   url: createUrl(index),
  //   content: { 
  //   returnGeometry: false,
  //   where: where(whereDates),
  //   outFields: ["EDITEDBY"],
  //   groupByFieldsForStatistics: ["EDITEDBY"],
  //   outStatistics: createOutStat(index),
  //   f: "pjson"
  //    },
    
  //   handleAs: "pjson",
  //   callbackParamName: "callback"
  // });

  //Response to server call
// $('input:radio[name="sewer"]').change(
//     function(){

        


  ///////////////////////////////////////////////////////////////////////////////////////
  
    function showResults(response) {
      var valveData = [];
      var lateralData = [];
      var mainsData = [];
      var fittingsData = [];
      var valveTotal = {'edited': 0, 'created':0};
      var lateralTotal = {'miles': 0, 'edited': 0, 'created':0};
      var mainTotal = {'miles': 0, 'edited': 0, 'created':0};
      var fittingsTotal = {'miles': 0, 'edited': 0, 'created':0};
      for (each in response.features){
        
        input = response.features[each].attributes;
        if (index == 1){
          fittingsData.push(input);
          var fittingsOptions = barOptions('Fittings', fittingsData, 'EDITEDBY', 'EDITED', 'CREATED');
          $("#fittingChart").dxChart(fittingsOptions);
          fittingsTotal.edited+=response.features[each].attributes.EDITED;
          fittingsTotal.created+=response.features[each].attributes.CREATED;
          document.getElementById('fittings').innerHTML='Total Edites: ' + fittingsTotal.edited + '<br>Total Creates: ' + fittingsTotal.created;
          
        }
        else if (index == 5){
    
          input = response.features[each].attributes;
          valveData.push(input);
          var valveOptions = pieOptions('Water Valves', valveData, 'EDITEDBY', 'EDITED' );
          piechange("#valvesPieChartContainer", valveOptions);
          window.valveOptions = valveOptions;
          valveTotal.edited+=response.features[each].attributes.EDITED;
          valveTotal.created+=response.features[each].attributes.CREATED;
          document.getElementById('valves').innerHTML='Total Edits: ' + valveTotal.edited; 
          window.valveTotal = valveTotal;

        }
        else if (index == 10){
          miles = new Number(response.features[each].attributes["SUM(SHAPE.LEN) AS SHAPELEN"] /5280);
          input["SUM(SHAPE.LEN) AS SHAPELEN"] = parseFloat(miles.toFixed(2));
          lateralData.push(input);
          var lateralOptions = pieOptions('Water Laterals', lateralData, 'EDITEDBY', 'SUM(SHAPE.LEN) AS SHAPELEN');
          piechange("#lateralPieChartContainer", lateralOptions);
          window.lateralOptions = lateralOptions;
          lateralTotal.edited+=response.features[each].attributes['COUNT(EDITEDBY) AS EDITED'];
          lateralTotal.miles+=response.features[each].attributes["SUM(SHAPE.LEN) AS SHAPELEN"];
          lateralTotal.created+=response.features[each].attributes['COUNT(CREATEDBY) AS CREATED'];
          lateralTotal.miles = Math.round(lateralTotal.miles);
          document.getElementById('laterals').innerHTML='Total Miles: ' + lateralTotal.miles; 
          window.lateralTotal = lateralTotal;
        }
        else if (index == 11){
          miles = new Number(response.features[each].attributes["SUM(SHAPE.LEN) AS SHAPELEN"] /5280);
          input["SUM(SHAPE.LEN) AS SHAPELEN"] = parseFloat(miles.toFixed(2));
          mainsData.push(input);
          var mainsOptions = pieOptions('Water Mains', mainsData, 'EDITEDBY', 'SUM(SHAPE.LEN) AS SHAPELEN' );
          piechange("#mainsPieChartContainer", mainsOptions);
          window.mainsOptions = mainsOptions;
           mainTotal.edited+=response.features[each].attributes['COUNT(EDITEDBY) AS EDITED'];
          mainTotal.miles+=response.features[each].attributes["SUM(SHAPE.LEN) AS SHAPELEN"];
          mainTotal.created+=response.features[each].attributes['COUNT(CREATEDBY) AS CREATED'];
          mainTotal.miles = Math.round(mainTotal.miles);
          document.getElementById('mains').innerHTML='Total Miles: ' + mainTotal.miles; 
          window.mainTotal = mainTotal;
        }  
      } //end for loop
      
      
      
    } //end of results function
  execute();
  });
  
      
} //end of calling()
for (i in index){
    calling(index[i]);
    }//end of for loop
$("#rangeSelectorContainer").dxRangeSelector({
    background: {
            color: '#eaebeb'
        },
     scale: {
      startValue: new Date(2013, 8, 1, 00,00,00),
      endValue: getCurrentDate('slide'), 
      majorTickInterval: 'month',
      minorTickInterval: 'month',
      showMinorTicks: true,
      marker: { visible: false },
      label: {format: 'monthAndYear'},
    },
      sliderMarker: {format: 'monthAndYear'},
      selectedRange : {
      startValue: getCurrentDate('slideBegin'), //getCurrentDate('slideBegin'),
      endValue: getCurrentDate('slide'),
    },
     behavior: {
     snapToTicks: true,
     allowSlidersSwap: false,
     callSelectedRangeChanged: 'onMovingComplete'
},
     selectedRangeChanged: function (e) {
      var sd = e.startValue.getDate();
      var sm = e.startValue.getMonth()+1;
      var sy = e.startValue.getFullYear();
      var ed = e.endValue.getDate();
      var em = e.endValue.getMonth()+1;
      var ey = e.endValue.getFullYear();
      if(sd<10){ 
      sd='0'+sd
    }
    if ( ed<10){
      ed='0'+ed
      } 

      if(sm<10){
      sm='0'+sm
    }
      if (em<10) {
      em='0'+em
      } 

    var start = sy+'-'+sm+'-'+sd + ' ' + '00:00:00';
    var end = ey+'-'+em+'-'+ed + ' ' + '00:00:00';
   
    whereDates.push(start, end);
    for (i in index){
    calling(index[i]);
    }//end of for loop
      
}
    });


//put back here

//***************************************************************************************************
function pieOptions(name, data, arg, val){
     var options = { dataSource: data,
          series: {
          type: 'doughnut',
          argumentField: arg,
          valueField: val,
          label: {
          visible: true,
          connector: {
          visible: true
          }
          }
        },
          
      tooltip: {
        enabled: true,
        percentPrecision: 2,
        customizeText: function (value) {
          return value.percentText;
        }
      },
    title: {
    text: name
    },
    legend: {
    horizontalAlignment: 'center',
    verticalAlignment: 'bottom'
    }

        }
        return options;
      }
 // var valveOptions = pieOptions('Water Valves', valveData, 'EDITEDBY', 'EDITED' );
 // var mainsOptions = pieOptions('Water Mains', mainsData, 'EDITEDBY', 'SUM(SHAPE.LEN) AS SHAPELEN' );
 // var lateralOptions = pieOptions('Water Laterals', lateralData, 'EDITEDBY', 'SUM(SHAPE.LEN) AS SHAPELEN');

////////////////////////////////////////////////////////////////////////////////////////////
//Fittings

function barOptions(name, data, arg, val1, val2){
var  options =  {dataSource: data,
            commonSeriesSettings: {
                      argumentField: arg,
                               type: 'stackedBar'
                                  },
                          series: [
                        { valueField: val1, name: val1 },
                        { valueField: val2, name: val2 }
                        
                                  ],
                          legend: {
                  verticalAlignment: 'bottom',
                horizontalAlignment: 'center'
                                  },
                              title: {
                              text: name
                                  }
                                }
                              return options;
}
 // var fittingsOptions = barOptions('Fittings', fittingsData, 'EDITEDBY', 'EDITED', 'CREATED');

//valvesPieChartContainer
function piechange(name, options){
  $(name).dxPieChart(options);
}


function check(value, id, options, val1, val2, val3, div, message, object){
  if(value == 1){
    options.series.valueField = val1; 
    piechange(id, options);
    document.getElementById(div).innerHTML=message + object;
    }
  else if(value == 2){
    options.series.valueField = val2;
    piechange(id, options);
    document.getElementById(div).innerHTML=message + object; 
    }
   else if(value == 3){
    options.series.valueField = val3;
    piechange(id, options);
    document.getElementById(div).innerHTML=message + object;  
    }
  } 


    </script>
  </body>
</html>
